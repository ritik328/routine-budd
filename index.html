<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Routine Buddy</title>
    
    <!-- PWA / Mobile Meta Tags -->
    <meta name="theme-color" id="meta-theme-color" content="#fdf2f8">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Routine Buddy">
    <link rel="apple-touch-icon" href="https://fonts.gstatic.com/s/i/shortterm/release/googlestyleshelf/emoji/v1/48px/1f338.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        darkBg: '#0f172a',
                        darkCard: '#1e293b',
                    }
                }
            }
        }
    </script>
    <style>
        :root {
            --vibe-color: rgb(255, 91, 137);
            --vibe-light: #fdf2f8;
            --accent-green: #dcfce7;
            --accent-green-dark: #22c55e;
            --text-main: #334155;
        }

        body {
            font-family: 'Quicksand', sans-serif;
            transition: background-color 0.4s ease, color 0.4s ease;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            overflow-x: hidden;
        }

        /* --- Heart Checkbox Styling --- */
        .heart-container {
            position: relative;
            width: 40px;
            height: 40px;
            transition: .3s;
            flex-shrink: 0;
        }

        .heart-container .checkbox {
            position: absolute;
            width: 100%;
            height: 100%;
            opacity: 0;
            z-index: 20;
            cursor: pointer;
        }

        .heart-container .svg-container {
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .heart-container .svg-outline {
            fill: #cbd5e1; /* Grey when unchecked */
            position: absolute;
            width: 28px;
            height: 28px;
            transition: all 0.3s;
        }

        .dark .heart-container .svg-outline {
            fill: #475569;
        }

        .heart-container .svg-filled {
            fill: var(--vibe-color);
            position: absolute;
            width: 28px;
            height: 28px;
            display: none;
        }

        .heart-container .checkbox:checked ~ .svg-container .svg-outline {
            display: none;
        }

        .heart-container .checkbox:checked ~ .svg-container .svg-filled {
            display: block;
            animation: keyframes-svg-filled 1s;
        }

        .heart-container .svg-celebrate {
            position: absolute;
            animation: keyframes-svg-celebrate .5s forwards;
            display: none;
            stroke: var(--vibe-color);
            fill: var(--vibe-color);
            stroke-width: 2px;
        }

        .heart-container .checkbox:checked ~ .svg-container .svg-celebrate {
            display: block;
        }

        @keyframes keyframes-svg-filled {
            0% { transform: scale(0); }
            25% { transform: scale(1.2); }
            50% { transform: scale(1); filter: brightness(1.5); }
        }

        @keyframes keyframes-svg-celebrate {
            0% { transform: scale(0); }
            50% { opacity: 1; filter: brightness(1.5); }
            100% { transform: scale(1.4); opacity: 0; }
        }

        /* --- UI Styles --- */
        .vibe-bg { background-color: var(--vibe-color); }
        .vibe-text { color: var(--vibe-color); }
        .vibe-border { border-color: var(--vibe-color); }
        
        .task-card { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .task-card:active:not(.read-only) { transform: scale(0.96); }
        .completed-card { background-color: var(--accent-green) !important; border-color: #bbf7d0 !important; }
        .dark .completed-card { background-color: #064e3b !important; border-color: #065f46 !important; }

        .progress-ring__circle {
            transition: stroke-dashoffset 0.5s ease-in-out;
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
        }

        #sidebar { transition: transform 0.3s ease-in-out; z-index: 100; }
        #sidebar.closed { transform: translateX(-100%); }
        #sidebar-overlay { transition: opacity 0.3s ease-in-out; z-index: 90; }

        .pipe-bar { transition: height 1s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .floating-message { animation: floatUp 2s forwards; pointer-events: none; }
        @keyframes floatUp { 0% { transform: translateY(0); opacity: 1; } 100% { transform: translateY(-50px); opacity: 0; } }

        .theme-toggle { position: relative; width: 60px; height: 32px; border-radius: 30px; cursor: pointer; transition: background-color 0.3s ease; }
        .toggle-knob { position: absolute; top: 4px; left: 4px; width: 24px; height: 24px; border-radius: 50%; background-color: white; transition: transform 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55); display: flex; align-items: center; justify-content: center; font-size: 14px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .dark .theme-toggle { background-color: #475569; }
        .light .theme-toggle { background-color: #f1f5f9; border: 1px solid #e2e8f0; }
        .dark .toggle-knob { transform: translateX(28px); background-color: #1e293b; }

        .modal-hidden { transform: translateY(100%); opacity: 0; pointer-events: none; }
        
        .pin-dot { width: 14px; height: 14px; border-radius: 50%; border: 2px solid #cbd5e1; transition: all 0.2s; }
        .pin-dot.filled { background-color: var(--vibe-color); border-color: var(--vibe-color); transform: scale(1.2); }

        .vibe-dot { width: 32px; height: 32px; border-radius: 50%; cursor: pointer; border: 3px solid transparent; transition: transform 0.2s; }
        .vibe-dot.active { border-color: white; box-shadow: 0 0 0 2px #cbd5e1; }

        ::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="bg-slate-50 text-slate-700 dark:bg-darkBg dark:text-slate-100 min-h-screen">

    <!-- SETUP SCREEN -->
    <div id="setup-screen" class="fixed inset-0 z-[200] bg-white dark:bg-darkBg p-8 flex flex-col justify-center items-center text-center hidden overflow-y-auto">
        <span class="text-6xl mb-6">üå∏</span>
        <h2 class="text-3xl font-bold text-slate-800 dark:text-slate-100 mb-2">Hi there!</h2>
        <p class="text-slate-500 mb-10">Let's set up your routine buddy.</p>
        
        <div class="w-full max-w-sm space-y-6">
            <div class="text-left">
                <label class="text-[10px] font-bold text-slate-400 uppercase tracking-widest ml-2">What's your name?</label>
                <input id="setup-name" type="text" placeholder="Enter name..." class="w-full mt-1 p-5 bg-slate-50 dark:bg-slate-900 rounded-3xl outline-none font-bold border-2 border-transparent focus:border-pink-200 transition-all">
            </div>

            <div class="text-left">
                <label class="text-[10px] font-bold text-slate-400 uppercase tracking-widest ml-2">Choose an emoji</label>
                <div class="grid grid-cols-5 gap-3 mt-2" id="setup-avatar-picker"></div>
            </div>

            <div class="text-left">
                <label class="text-[10px] font-bold text-slate-400 uppercase tracking-widest ml-2">Privacy PIN (Optional)</label>
                <input id="setup-pin" type="tel" maxlength="4" placeholder="4 digits" class="w-full mt-1 p-5 bg-slate-50 dark:bg-slate-900 rounded-3xl outline-none font-bold border-2 border-transparent focus:border-pink-200 transition-all text-center tracking-[1em]">
            </div>

            <button onclick="completeSetup()" class="w-full p-5 bg-gradient-to-r from-pink-400 to-pink-500 text-white font-bold rounded-3xl shadow-xl shadow-pink-100 active:scale-95 transition-all">
                Let's Start! ‚ú®
            </button>
        </div>
    </div>

    <!-- PIN UNLOCK SCREEN -->
    <div id="pin-screen" class="fixed inset-0 z-[190] bg-white/90 dark:bg-darkBg/95 backdrop-blur-md flex flex-col items-center justify-center hidden">
        <span id="pin-avatar" class="text-6xl mb-4">üå∏</span>
        <h2 id="pin-greeting" class="text-xl font-bold text-slate-800 dark:text-slate-100 mb-8">Welcome back!</h2>
        <div class="flex gap-4 mb-12">
            <div class="pin-dot"></div><div class="pin-dot"></div><div class="pin-dot"></div><div class="pin-dot"></div>
        </div>
        <div class="grid grid-cols-3 gap-6 max-w-[280px]" id="pin-pad">
            <!-- Numeric pad injected via JS -->
        </div>
    </div>

    <!-- MAIN APP WRAPPER -->
    <div id="app-content" class="hidden opacity-0 transition-opacity duration-700">
        <!-- Sidebar Overlay -->
        <div id="sidebar-overlay" class="fixed inset-0 bg-slate-900/40 backdrop-blur-sm hidden" onclick="toggleSidebar()"></div>

        <!-- Quick Notes Modal -->
        <div id="notes-modal" class="fixed inset-0 flex flex-col justify-end modal-hidden">
            <div class="bg-black/20 backdrop-blur-sm absolute inset-0" onclick="toggleNotes()"></div>
            <div class="bg-white dark:bg-darkCard rounded-t-[40px] p-8 pb-12 relative shadow-2xl max-h-[85vh] flex flex-col">
                <div class="w-12 h-1.5 bg-slate-200 dark:bg-slate-700 rounded-full mx-auto mb-6"></div>
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-bold vibe-text">Quick Notes ‚ú®</h3>
                    <button onclick="toggleNotes()" class="p-2 bg-slate-100 dark:bg-slate-800 rounded-full">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>
                <div class="flex gap-2 mb-6">
                    <input id="note-input" type="text" placeholder="Write something important..." class="flex-grow bg-slate-50 dark:bg-slate-900 p-4 rounded-2xl outline-none font-medium border-2 border-transparent focus:border-slate-200 dark:focus:border-slate-700 transition-all text-sm">
                    <button onclick="addNote()" class="vibe-bg p-4 rounded-2xl text-white shadow-lg active:scale-90 transition-transform">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                    </button>
                </div>
                <div id="notes-list" class="space-y-3 overflow-y-auto flex-grow pb-4"></div>
            </div>
        </div>

        <!-- Sidebar -->
        <aside id="sidebar" class="fixed top-0 left-0 bottom-0 w-64 bg-pink-50 dark:bg-slate-800 shadow-2xl p-6 closed border-r dark:border-slate-700">
            <div class="flex items-center gap-2 mb-8 mt-4">
                <span id="sidebar-avatar" class="text-2xl">üå∏</span>
                <h2 id="sidebar-name" class="font-bold text-xl vibe-text">Buddy</h2>
            </div>
            <nav class="space-y-2">
                <button onclick="switchTab('today')" class="w-full flex items-center gap-3 p-4 rounded-2xl bg-white dark:bg-slate-700 text-slate-700 dark:text-slate-200 font-bold shadow-sm border border-slate-100 dark:border-slate-600 transition-all active:scale-95"><span>üìÖ</span> Today</button>
                <button onclick="switchTab('detail-stats')" class="w-full flex items-center gap-3 p-4 rounded-2xl bg-white dark:bg-slate-700 text-slate-700 dark:text-slate-200 font-bold shadow-sm border border-slate-100 dark:border-slate-600 transition-all active:scale-95"><span>üìä</span> Stats</button>
                <button onclick="switchTab('milestones')" class="w-full flex items-center gap-3 p-4 rounded-2xl bg-white dark:bg-slate-700 text-slate-700 dark:text-slate-200 font-bold shadow-sm border border-slate-100 dark:border-slate-600 transition-all active:scale-95"><span>üèÖ</span> Milestones</button>
                <button onclick="switchTab('settings')" class="w-full flex items-center gap-3 p-4 rounded-2xl bg-white dark:bg-slate-700 text-slate-700 dark:text-slate-200 font-bold shadow-sm border border-slate-100 dark:border-slate-600 transition-all active:scale-95"><span>‚öôÔ∏è</span> Settings</button>
                <button id="install-btn" class="hidden w-full flex items-center gap-3 p-4 rounded-2xl vibe-bg text-white font-bold shadow-md transition-all active:scale-95"><span>üì≤</span> Install App</button>
                <button onclick="switchTab('about')" class="w-full flex items-center gap-3 p-4 rounded-2xl bg-white dark:bg-slate-700 text-slate-700 dark:text-slate-200 font-bold shadow-sm border border-slate-100 dark:border-slate-600 transition-all active:scale-95"><span>üíñ</span> Share App</button>
            </nav>
        </aside>

        <!-- Navigation -->
        <nav class="p-4 flex items-center justify-between sticky top-0 bg-white/70 dark:bg-darkBg/70 backdrop-blur-md z-30 transition-colors">
            <div class="flex items-center gap-4">
                <button onclick="toggleSidebar()" class="p-3 bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-100 dark:border-slate-700 active:scale-90 transition-transform"><svg class="w-6 h-6 text-slate-600 dark:text-slate-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg></button>
            </div>
            <div class="theme-toggle" onclick="toggleTheme()" id="theme-toggle"><div class="toggle-knob" id="toggle-knob">üåû</div></div>
        </nav>

        <!-- Views Container -->
        <div id="views-container">
            <!-- Today View -->
            <div id="view-today" class="pb-32">
                <header class="px-6 pt-4 pb-4">
                    <!-- Sunday Summary Header -->
                    <div id="sunday-summary" class="hidden mb-6 p-5 bg-gradient-to-br from-yellow-50 to-orange-50 dark:from-yellow-900/20 dark:to-orange-900/20 rounded-3xl border border-yellow-100 dark:border-yellow-800 shadow-sm animate-pulse">
                        <div class="flex items-center gap-3">
                            <span class="text-3xl">üíê</span>
                            <div>
                                <h4 class="text-sm font-bold text-orange-800 dark:text-orange-300">Sunday Bloom!</h4>
                                <p id="bloom-score-text" class="text-xs text-orange-600 dark:text-orange-400">Loading your week...</p>
                            </div>
                        </div>
                    </div>

                    <div class="flex justify-between items-start">
                        <div class="relative">
                            <h1 id="greeting" class="text-2xl font-bold text-slate-800 dark:text-slate-100 leading-tight">Good Morning!</h1>
                            <p id="current-date" class="text-xs text-slate-500 dark:text-slate-400 font-medium mt-0.5">Today is ...</p>
                            <div id="buddy-bubble" class="mt-3 flex items-center gap-2 p-2 px-3 bg-white dark:bg-slate-800 rounded-2xl rounded-tl-none border border-slate-100 dark:border-slate-700 shadow-sm w-fit transition-all duration-500">
                                <span class="text-xs font-semibold vibe-text" id="buddy-text">You got this! ‚ú®</span>
                            </div>
                        </div>
                        <div class="flex flex-col items-end gap-2">
                            <span id="streak-badge" class="px-3 py-1 bg-orange-100 dark:bg-orange-900/30 text-orange-600 dark:text-orange-400 rounded-full text-xs font-bold shadow-sm">0 Days üî•</span>
                            <button onclick="toggleNotes()" class="relative px-3 py-1.5 bg-white dark:bg-slate-800 border border-slate-100 dark:border-slate-700 text-slate-600 dark:text-slate-300 rounded-full text-xs font-bold shadow-sm active:scale-95 transition-all flex items-center gap-1.5">Notes üìù<span id="notes-count-badge" class="hidden absolute -top-1 -right-1 w-2.5 h-2.5 vibe-bg rounded-full border border-white dark:border-slate-900"></span></button>
                        </div>
                    </div>
                    <div class="mt-6 flex flex-col gap-2">
                        <div class="flex justify-between items-center text-[10px] font-bold text-slate-400 uppercase tracking-widest"><span>Hydration</span><span id="water-count">0/8 Cups</span></div>
                        <div class="flex justify-between gap-1" id="water-droplets"></div>
                    </div>
                    <div class="mt-6 p-4 bg-white dark:bg-darkCard rounded-2xl border border-pink-100 dark:border-slate-800 shadow-sm transition-colors">
                        <p id="daily-quote" class="text-sm font-medium vibe-text italic leading-snug">"Small steps lead to big dreams. ‚ú®"</p>
                    </div>
                </header>
                <main class="px-6 space-y-4" id="task-container"></main>
                <div id="perfect-day-reward" class="hidden px-6 mt-8 text-center animate-bounce">
                    <div class="bg-yellow-100 dark:bg-yellow-900/20 rounded-3xl p-6 border-2 border-yellow-200 dark:border-yellow-800">
                        <span class="text-6xl block mb-2">üëë</span>
                        <h2 id="reward-title" class="text-xl font-bold text-yellow-800 dark:text-yellow-400 text-center">Routine Queen!</h2>
                        <p id="reward-text" class="text-yellow-700 dark:text-yellow-500 text-sm text-center">Conquered the day!</p>
                    </div>
                </div>
                <section class="mt-12 px-6 pb-12 border-t border-slate-100 dark:border-slate-800 pt-8">
                    <div class="flex justify-between items-center mb-6">
                        <h3 id="stats-title" class="text-xl font-bold text-slate-700 dark:text-slate-200 flex items-center gap-2">üå∏ Stats</h3>
                        <div class="flex bg-slate-100 dark:bg-slate-800 p-1 rounded-xl">
                            <button id="btn-week" onclick="setChartRange('week')" class="px-3 py-1.5 text-[10px] font-bold uppercase rounded-lg transition-all">Week</button>
                            <button id="btn-month" onclick="setChartRange('month')" class="px-3 py-1.5 text-[10px] font-bold uppercase rounded-lg transition-all">Month</button>
                        </div>
                    </div>
                    <div class="bg-white dark:bg-darkCard p-6 rounded-3xl shadow-sm border border-slate-50 dark:border-slate-800 mb-4 overflow-hidden">
                        <div id="chart-container" class="flex items-end justify-between h-48 gap-2 overflow-x-auto pb-4 scroll-smooth"></div>
                    </div>
                </section>
            </div>

            <!-- Detail Stats View -->
            <div id="view-detail-stats" class="hidden px-6 pt-8 pb-40 overflow-y-auto">
                <h2 class="text-2xl font-bold text-slate-800 dark:text-slate-100 mb-2">Insights üìä</h2>
                <p id="detail-stats-subtitle" class="text-sm text-slate-500 dark:text-slate-400 mb-8">How you're growing!</p>
                <div class="grid grid-cols-2 gap-4 mb-8" id="stats-summary-grid"></div>
                <div class="bg-white dark:bg-darkCard p-6 rounded-[32px] border border-slate-100 dark:border-slate-800 mb-8">
                    <h4 class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-6 text-center">Routine Patterns</h4>
                    <div id="routine-breakdown-list" class="space-y-4"></div>
                </div>
            </div>

            <!-- Milestones View -->
            <div id="view-milestones" class="hidden px-6 pt-8 pb-32">
                <h2 id="milestones-title" class="text-2xl font-bold text-slate-800 dark:text-slate-100 mb-2">Milestones üèÖ</h2>
                <div class="grid grid-cols-2 gap-4 mt-8" id="milestone-grid"></div>
            </div>

            <!-- Settings View -->
            <div id="view-settings" class="hidden px-6 pt-8 pb-32">
                <h2 class="text-2xl font-bold text-slate-800 dark:text-slate-100 mb-6">Settings ‚öôÔ∏è</h2>
                <div class="space-y-8">
                    <div class="bg-white dark:bg-darkCard p-6 rounded-3xl border border-slate-100 dark:border-slate-800">
                        <label class="block text-xs font-bold text-slate-400 uppercase mb-3 ml-2">Display Name</label>
                        <input id="setting-name" type="text" oninput="updateUserNameSetting()" class="w-full bg-slate-50 dark:bg-slate-900 p-4 rounded-2xl outline-none font-bold vibe-text">
                    </div>
                    <div class="bg-white dark:bg-darkCard p-6 rounded-3xl border border-slate-100 dark:border-slate-800">
                        <label class="block text-xs font-bold text-slate-400 uppercase mb-4 ml-2">Pick your Vibe</label>
                        <div class="flex justify-between" id="vibe-selector">
                            <div onclick="changeVibe('pink', '#f472b6')" class="vibe-dot bg-[#f472b6]" data-vibe="pink"></div>
                            <div onclick="changeVibe('lavender', '#a78bfa')" class="vibe-dot bg-[#a78bfa]" data-vibe="lavender"></div>
                            <div onclick="changeVibe('mint', '#34d399')" class="vibe-dot bg-[#34d399]" data-vibe="mint"></div>
                            <div onclick="changeVibe('sky', '#38bdf8')" class="vibe-dot bg-[#38bdf8]" data-vibe="sky"></div>
                            <div onclick="changeVibe('peach', '#fb923c')" class="vibe-dot bg-[#fb923c]" data-vibe="peach"></div>
                        </div>
                    </div>
                    <button onclick="logoutProfile()" class="w-full p-5 bg-slate-100 dark:bg-slate-800 text-slate-500 font-bold rounded-3xl active:scale-95 transition-all mt-4">Change Profile üîê</button>
                </div>
            </div>

            <!-- About View -->
            <div id="view-about" class="hidden px-6 pt-10">
                <div class="text-center">
                    <span class="text-7xl">üíñ</span>
                    <h1 class="text-3xl font-bold text-slate-800 dark:text-slate-100 mt-6">Share Buddy</h1>
                    <p id="about-text" class="text-slate-500 dark:text-slate-400 mt-4 px-4">Routine Buddy keeps you growing every day!</p>
                    <button onclick="copyAppShare()" class="w-full vibe-bg text-white p-5 rounded-3xl font-bold shadow-lg active:scale-95 transition-all mt-10">üîó Copy Share Link</button>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <footer id="bottom-bar" class="fixed bottom-0 left-0 right-0 bg-white/90 dark:bg-slate-900/90 backdrop-blur-md border-t border-slate-100 dark:border-slate-800 p-5 px-8 flex flex-col items-center shadow-lg z-40 transition-colors">
            <div class="w-full bg-slate-100 dark:bg-slate-800 h-2.5 rounded-full overflow-hidden mb-3">
                <div id="progress-bar" class="h-full vibe-bg transition-all duration-500 w-0"></div>
            </div>
            <div class="flex justify-between w-full items-center">
                <p id="progress-text" class="font-bold text-slate-700 dark:text-slate-300 text-xs">0 / 0 tasks</p>
                <p id="motivation-msg" class="text-[10px] text-slate-500 italic">Let's go! üöÄ</p>
            </div>
        </footer>
    </div>

    <div id="toast-container" class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 pointer-events-none flex flex-col items-center z-[300]"></div>

    <script>
        // --- CONFIG & STATE ---
        let PROFILE = JSON.parse(localStorage.getItem('routine-profile'));
        let USER_NAME = PROFILE?.name || "Disha";
        let USER_AVATAR = PROFILE?.avatar || "üå∏";
        let USER_PIN = PROFILE?.pin || "";
        let CURRENT_PIN_INPUT = "";
        let CURRENT_VIBE = localStorage.getItem('currentVibe') || "pink";
        let CURRENT_VIBE_HEX = localStorage.getItem('currentVibeHex') || "#f472b6";
        
        let completedIds = JSON.parse(localStorage.getItem('completedTasks') || '[]');
        let waterCount = parseInt(localStorage.getItem('waterCount') || '0');
        let quickNotes = JSON.parse(localStorage.getItem('quickNotes') || '[]');
        let streak = parseInt(localStorage.getItem('streak') || '0');
        let chartRange = 'week';
        let isDemoMode = false;

        const tasks = [
            { id: 'wake', text: 'Wake Up', time: '6:30 AM', emoji: 'üåû' },
            { id: 'ready', text: 'Get Ready', time: '6:30 ‚Äì 7:30 AM', emoji: 'ü™•' },
            { id: 'college', text: 'College + Travel', time: '7:30 ‚Äì 2:00 PM', emoji: 'üéí' },
            { id: 'return', text: 'Return Home', time: '2:00 ‚Äì 3:20 PM', emoji: 'üö∂‚Äç‚ôÄÔ∏è' },
            { id: 'lunch', text: 'Lunch / Rest', time: '3:20 ‚Äì 4:00 PM', emoji: 'üçΩÔ∏è' },
            { id: 'tuition', text: 'Tuition', time: '4:00 ‚Äì 6:00 PM', emoji: '‚úèÔ∏è' },
            { id: 'study1', text: 'Self Study', time: '6:15 ‚Äì 7:30 PM', emoji: 'üß†' },
            { id: 'relax', text: 'Relax / Timepass', time: '7:30 ‚Äì 8:00 PM', emoji: 'üéß' },
            { id: 'dinner', text: 'Dinner Prep + Eat', time: '8:00 ‚Äì 9:00 PM', emoji: 'üç≥' },
            { id: 'study2', text: 'Study', time: '10:30 ‚Äì 11:30 PM', emoji: 'üìñ' },
            { id: 'sleep', text: 'Sleep', time: '12:00 AM', emoji: 'üò¥' }
        ];

        const meaningfulQuotes = [
            `Small steps lead to big dreams, ${USER_NAME}. ‚ú®`, `Be kind to yourself today, ${USER_NAME}. üå∏`, `You are doing your best. üíñ`,
            "Today is a new chance to bloom. üåø", `Radiate positivity! üåû`, "Your progress is beautiful. ü¶ã",
            `Focus on the good. üåà`, "Every day is a fresh page. üìñ", `${USER_NAME}, you are so strong. üí™`
        ];

        const milestones = [
            { id: 'first', text: 'First Day Done', emoji: 'üå±', req: 1 },
            { id: 'week', text: 'Weekly Bloom', emoji: 'üå∏', req: 7 },
            { id: 'biweek', text: 'Stardust Consistency', emoji: '‚ú®', req: 14 },
            { id: 'month', text: 'Routine Queen', emoji: 'üëë', req: 30 }
        ];

        // --- GATE LOGIC ---
        const initGate = () => {
            if (!PROFILE) showSetup();
            else if (USER_PIN) showPinLock();
            else showApp();
        };

        const showSetup = () => {
            const setup = document.getElementById('setup-screen');
            setup.classList.remove('hidden');
            const picker = document.getElementById('setup-avatar-picker');
            picker.innerHTML = '';
            ["üå∏", "üë∏", "‚ú®", "ü¶ã", "üå∑", "üéÄ", "üç≠", "üß∏", "üêö", "üåô"].forEach(emoji => {
                const btn = document.createElement('button');
                btn.className = "text-2xl p-2 bg-slate-100 dark:bg-slate-800 rounded-2xl active:scale-90 transition-all";
                btn.innerText = emoji;
                btn.onclick = () => {
                    USER_AVATAR = emoji;
                    picker.querySelectorAll('button').forEach(b => b.classList.remove('ring-2', 'ring-pink-400'));
                    btn.classList.add('ring-2', 'ring-pink-400');
                };
                picker.appendChild(btn);
            });
        };

        const completeSetup = () => {
            const name = document.getElementById('setup-name').value.trim();
            const pin = document.getElementById('setup-pin').value.trim();
            if (!name) { showPositiveToast("Enter a name! üíñ"); return; }
            USER_NAME = name; USER_PIN = pin;
            PROFILE = { name, avatar: USER_AVATAR, pin };
            localStorage.setItem('routine-profile', JSON.stringify(PROFILE));
            document.getElementById('setup-screen').classList.add('hidden');
            showApp();
        };

        const showPinLock = () => {
            document.getElementById('pin-screen').classList.remove('hidden');
            document.getElementById('pin-avatar').innerText = USER_AVATAR;
            document.getElementById('pin-greeting').innerText = `Welcome back, ${USER_NAME}!`;
            const pad = document.getElementById('pin-pad'); pad.innerHTML = '';
            [1,2,3,4,5,6,7,8,9,null,0,'del'].forEach(n => {
                if (n === null) { pad.appendChild(document.createElement('div')); return; }
                const b = document.createElement('button');
                b.className = "w-16 h-16 rounded-full bg-white dark:bg-slate-800 shadow-sm border border-slate-100 dark:border-slate-700 font-bold text-xl active:scale-90 transition-all";
                if (n === 'del') {
                    b.innerHTML = '<svg class="w-6 h-6 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M12 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2M3 12l6.414 6.414A2 2 0 0010.828 19H19a2 2 0 002-2V7a2 2 0 00-2-2h-8.172a2 2 0 00-1.414.586L3 12z"></path></svg>';
                    b.onclick = pinDelete;
                } else {
                    b.innerText = n;
                    b.onclick = () => pinInput(n);
                }
                pad.appendChild(b);
            });
        };

        const pinInput = (n) => {
            if (CURRENT_PIN_INPUT.length >= 4) return;
            CURRENT_PIN_INPUT += n;
            updatePinDots();
            if (CURRENT_PIN_INPUT.length === 4) {
                if (CURRENT_PIN_INPUT === USER_PIN) {
                    document.getElementById('pin-screen').classList.add('hidden');
                    showApp();
                } else {
                    CURRENT_PIN_INPUT = "";
                    setTimeout(updatePinDots, 200);
                    showPositiveToast("Wrong PIN! ‚ùå");
                }
            }
        };

        const pinDelete = () => { CURRENT_PIN_INPUT = CURRENT_PIN_INPUT.slice(0, -1); updatePinDots(); };
        const updatePinDots = () => { document.querySelectorAll('.pin-dot').forEach((d, i) => d.classList.toggle('filled', i < CURRENT_PIN_INPUT.length)); };

        const showApp = () => {
            const app = document.getElementById('app-content');
            app.classList.remove('hidden');
            setTimeout(() => app.classList.add('opacity-100'), 50);
            startApp();
        };

        // --- APP LOGIC ---
        function startApp() {
            initTheme(); applyVibe(); checkDailyReset(); updateStaticText(); setHeader();
            renderTasks(); renderChart(); renderWater(); updateProgress();
            setInterval(checkDailyReset, 60000);
            setupPWA();
        }

        function checkDailyReset() {
            const today = `${new Date().getFullYear()}-${new Date().getMonth() + 1}-${new Date().getDate()}`;
            const lastDate = localStorage.getItem('lastActiveDate');
            const history = JSON.parse(localStorage.getItem('routineHistory') || '{}');

            if (lastDate && lastDate !== today) {
                const diff = Math.ceil(Math.abs(new Date(today) - new Date(lastDate)) / (1000 * 60 * 60 * 24));
                if (diff > 1 || !history[lastDate] || history[lastDate] < 1) streak = 0;
                
                let lw = parseInt(localStorage.getItem('totalWaterLifetime') || '0');
                localStorage.setItem('totalWaterLifetime', (lw + waterCount).toString());

                completedIds = []; waterCount = 0;
                localStorage.setItem('completedTasks', '[]'); localStorage.setItem('waterCount', '0');
                localStorage.setItem('journal', "");
            }
            localStorage.setItem('lastActiveDate', today);
            localStorage.setItem('streak', streak.toString());
            const b = document.getElementById('streak-badge'); if (b) b.innerText = `${streak} Days üî•`;
            checkSundaySummary(); updateNotesBadge();
        }

        function toggleTask(id) {
            if (isDemoMode) return;
            const idx = completedIds.indexOf(id);
            if (idx > -1) completedIds.splice(idx, 1);
            else { completedIds.push(id); showPositiveToast(); playSparkleSound(); }
            localStorage.setItem('completedTasks', JSON.stringify(completedIds));
            renderTasks(); updateProgress();
            if (completedIds.length === tasks.length) handlePerfectDay();
        }

        function handlePerfectDay() {
            const today = `${new Date().getFullYear()}-${new Date().getMonth() + 1}-${new Date().getDate()}`;
            const history = JSON.parse(localStorage.getItem('routineHistory') || '{}');
            if (!history[today]) {
                streak++; localStorage.setItem('streak', streak.toString());
                let tp = (parseInt(localStorage.getItem('totalPerfectDays') || '0')) + 1;
                localStorage.setItem('totalPerfectDays', tp.toString());
                let maxS = parseInt(localStorage.getItem('maxStreak') || '0');
                localStorage.setItem('maxStreak', Math.max(maxS, streak).toString());
                const b = document.getElementById('streak-badge'); if (b) b.innerText = `${streak} Days üî•`;
                triggerConfetti();
            }
            history[today] = 1; localStorage.setItem('routineHistory', JSON.stringify(history));
            renderChart(); setHeader();
        }

        function renderTasks() {
            const container = document.getElementById('task-container'); if (!container) return;
            container.innerHTML = '';
            tasks.forEach(t => {
                const isDone = completedIds.includes(t.id);
                const card = document.createElement('div');
                card.className = `task-card p-5 rounded-3xl border-2 flex items-center justify-between shadow-sm ${isDone ? 'completed-card' : 'bg-white dark:bg-darkCard border-slate-50 dark:border-slate-800'}`;
                card.onclick = () => toggleTask(t.id);
                card.innerHTML = `<div class="flex items-center gap-4"><span class="text-2xl">${t.emoji}</span><div><p class="font-bold text-sm ${isDone ? 'vibe-text' : 'text-slate-700 dark:text-slate-200'}">${t.text}</p><p class="text-[9px] font-bold text-slate-400 uppercase tracking-widest">${t.time}</p></div></div><div class="heart-container"><input type="checkbox" class="checkbox" ${isDone ? 'checked' : ''} disabled><div class="svg-container"><svg viewBox="0 0 24 24" class="svg-outline" xmlns="http://www.w3.org/2000/svg"><path d="M17.5,1.917a6.4,6.4,0,0,0-5.5,3.3,6.4,6.4,0,0,0-5.5-3.3A6.8,6.8,0,0,0,0,8.967c0,4.547,4.786,9.513,8.8,12.88a4.974,4.974,0,0,0,6.4,0C19.214,18.48,24,13.514,24,8.967A6.8,6.8,0,0,0,17.5,1.917Zm-3.585,18.4a2.973,2.973,0,0,1-3.83,0C4.947,16.006,2,11.87,2,8.967a4.8,4.8,0,0,1,4.5-5.05,4.8,4.8,0,0,1,4.5,5.05,1,1,0,0,0,2,0,4.8,4.8,0,0,1,4.5-5.05,4.8,4.8,0,0,1,4.5,5.05C22,11.87,19.053,16.006,13.915,20.317Z"></path></svg><svg viewBox="0 0 24 24" class="svg-filled" xmlns="http://www.w3.org/2000/svg"><path d="M17.5,1.917a6.4,6.4,0,0,0-5.5,3.3,6.4,6.4,0,0,0-5.5-3.3A6.8,6.8,0,0,0,0,8.967c0,4.547,4.786,9.513,8.8,12.88a4.974,4.974,0,0,0,6.4,0C19.214,18.48,24,13.514,24,8.967A6.8,6.8,0,0,0,17.5,1.917Z"></path></svg><svg class="svg-celebrate" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><polygon points="50,10 55,20 65,20 60,30 65,40 55,40 50,50 45,40 35,40 40,30 35,20 45,20"></polygon></svg></div></div>`;
                container.appendChild(card);
            });
        }

        function updateProgress() {
            const p = (completedIds.length / tasks.length) * 100;
            const bar = document.getElementById('progress-bar'); if (bar) bar.style.width = `${p}%`;
            const text = document.getElementById('progress-text'); if (text) text.innerText = `${completedIds.length} / ${tasks.length} tasks`;
            const label = document.getElementById('circle-percent'); if (label) label.innerText = `${Math.round(p)}%`;
            const circle = document.getElementById('circular-progress-bar');
            if (circle) circle.style.strokeDashoffset = (32 * 2 * Math.PI) - (p / 100 * (32 * 2 * Math.PI));
        }

        function setHeader() {
            document.getElementById('greeting').innerText = `Good Morning, ${USER_NAME}!`;
            document.getElementById('current-date').innerText = new Date().toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });
            const dOfYear = Math.floor((new Date() - new Date(new Date().getFullYear(), 0, 0)) / 86400000);
            document.getElementById('daily-quote').innerText = `"${meaningfulQuotes[dOfYear % meaningfulQuotes.length]}"`;
        }

        function renderChart() {
            const cont = document.getElementById('chart-container'); if (!cont) return;
            cont.innerHTML = '';
            const history = JSON.parse(localStorage.getItem('routineHistory') || '{}');
            const todayStr = `${new Date().getFullYear()}-${new Date().getMonth() + 1}-${new Date().getDate()}`;
            for (let i = 6; i >= 0; i--) {
                const d = new Date(); d.setDate(d.getDate() - i);
                const k = `${d.getFullYear()}-${d.getMonth() + 1}-${d.getDate()}`;
                const val = (k === todayStr) ? (completedIds.length / tasks.length) : (history[k] || 0);
                const col = document.createElement('div');
                col.className = "flex flex-col items-center flex-1 h-full";
                col.innerHTML = `<span class="text-xs mb-1">${val >= 1 ? 'üëë' : 'üå±'}</span><div class="w-3 rounded-full bg-slate-100 dark:bg-slate-800 flex-grow relative flex flex-col justify-end"><div class="pipe-bar w-full vibe-bg rounded-full" style="height: ${Math.round(val * 100)}%"></div></div><span class="text-[8px] mt-2 font-bold">${d.getDate()}</span>`;
                cont.appendChild(col);
            }
        }

        function renderDetailedStats() {
            const history = JSON.parse(localStorage.getItem('routineHistory') || '{}');
            const lifetimeWater = parseInt(localStorage.getItem('totalWaterLifetime') || '0') + waterCount;
            const maxS = parseInt(localStorage.getItem('maxStreak') || '0');
            const grid = document.getElementById('stats-summary-grid');
            grid.innerHTML = `
                <div class="bg-white dark:bg-darkCard p-5 rounded-3xl border border-slate-100 dark:border-slate-800 text-center"><p class="text-2xl font-bold vibe-text">${completedIds.length}</p><p class="text-[10px] text-slate-400 font-bold uppercase mt-1">Today's Tasks</p></div>
                <div class="bg-white dark:bg-darkCard p-5 rounded-3xl border border-slate-100 dark:border-slate-800 text-center"><p class="text-2xl font-bold text-orange-500">${maxS}</p><p class="text-[10px] text-slate-400 font-bold uppercase mt-1">Best Streak</p></div>
                <div class="bg-white dark:bg-darkCard p-5 rounded-3xl border border-slate-100 dark:border-slate-800 text-center"><p class="text-2xl font-bold text-cyan-500">${lifetimeWater}</p><p class="text-[10px] text-slate-400 font-bold uppercase mt-1">Total Water</p></div>
                <div class="bg-white dark:bg-darkCard p-5 rounded-3xl border border-slate-100 dark:border-slate-800 text-center"><p class="text-2xl font-bold text-blue-500">${Object.keys(history).length + 1}</p><p class="text-[10px] text-slate-400 font-bold uppercase mt-1">Days Active</p></div>
            `;
            const breakdown = document.getElementById('routine-breakdown-list');
            breakdown.innerHTML = '';
            tasks.forEach(t => {
                const done = completedIds.includes(t.id) ? 100 : 70; // Faking consistency visualization
                breakdown.innerHTML += `<div class="flex flex-col gap-1"><div class="flex justify-between text-[10px] font-bold text-slate-400"><span>${t.emoji} ${t.text}</span><span>${done}%</span></div><div class="w-full h-1.5 bg-slate-100 dark:bg-slate-800 rounded-full overflow-hidden"><div class="h-full vibe-bg" style="width: ${done}%"></div></div></div>`;
            });
        }

        function renderMilestones() {
            const grid = document.getElementById('milestone-grid'); if (!grid) return; grid.innerHTML = '';
            const total = parseInt(localStorage.getItem('totalPerfectDays') || '0');
            milestones.forEach(m => {
                const unlocked = total >= m.req;
                grid.innerHTML += `<div class="p-6 rounded-3xl border-2 flex flex-col items-center text-center transition-all ${unlocked ? 'bg-white dark:bg-darkCard border-pink-100' : 'grayscale opacity-40 bg-slate-50 border-transparent'}"><span class="text-5xl mb-4">${m.emoji}</span><h3 class="font-bold text-sm dark:text-slate-200">${m.text}</h3><p class="text-[10px] text-slate-400 mt-1">${unlocked ? 'Unlocked!' : `${total}/${m.req} days`}</p></div>`;
            });
        }

        function renderWater() {
            const cont = document.getElementById('water-droplets'); if (!cont) return;
            cont.innerHTML = '';
            for (let i = 0; i < 8; i++) {
                const d = document.createElement('div');
                d.className = `droplet w-8 h-8 rounded-full border-2 flex items-center justify-center text-sm cursor-pointer ${i < waterCount ? 'bg-blue-400 border-blue-500' : 'border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-900'}`;
                d.innerHTML = i < waterCount ? 'üíß' : '‚ö™Ô∏è';
                d.onclick = () => { if(!isDemoMode) { waterCount = (i + 1 === waterCount) ? i : i + 1; localStorage.setItem('waterCount', waterCount); renderWater(); } };
                cont.appendChild(d);
            }
            document.getElementById('water-count').innerText = `${waterCount}/8 Cups`;
        }

        function toggleNotes() { document.getElementById('notes-modal').classList.toggle('modal-hidden'); renderNotes(); }
        function addNote() { const i = document.getElementById('note-input'); const t = i.value.trim(); if(!t) return; quickNotes.unshift({id: Date.now(), text: t, done: false}); localStorage.setItem('quickNotes', JSON.stringify(quickNotes)); i.value = ''; renderNotes(); updateNotesBadge(); }
        function toggleNoteState(id) { quickNotes = quickNotes.map(n => n.id === id ? {...n, done: !n.done} : n); localStorage.setItem('quickNotes', JSON.stringify(quickNotes)); renderNotes(); updateNotesBadge(); }
        function deleteNote(id) { quickNotes = quickNotes.filter(n => n.id !== id); localStorage.setItem('quickNotes', JSON.stringify(quickNotes)); renderNotes(); updateNotesBadge(); }
        function renderNotes() {
            const c = document.getElementById('notes-list'); c.innerHTML = quickNotes.length ? '' : '<p class="text-center text-slate-400 text-sm py-10">No notes yet! ‚òÅÔ∏è</p>';
            quickNotes.forEach(n => {
                c.innerHTML += `<div class="flex items-center gap-3 p-4 bg-slate-50 dark:bg-slate-900 rounded-2xl ${n.done ? 'opacity-50' : ''}"><button onclick="toggleNoteState(${n.id})" class="shrink-0 w-6 h-6 border-2 ${n.done ? 'vibe-bg' : 'border-slate-300'} rounded-lg flex items-center justify-center">${n.done ? '‚úì' : ''}</button><span class="text-sm font-bold flex-grow ${n.done ? 'line-through' : ''}">${n.text}</span><button onclick="deleteNote(${n.id})" class="text-slate-300">‚úï</button></div>`;
            });
        }
        function updateNotesBadge() { const b = document.getElementById('notes-count-badge'); b.classList.toggle('hidden', !quickNotes.some(n => !n.done)); }

        function checkSundaySummary() {
            const now = new Date(); if (now.getDay() !== 0) return;
            document.getElementById('sunday-summary').classList.remove('hidden');
            document.getElementById('bloom-score-text').innerText = `${USER_NAME}, it's Sunday! Great job on your week! üíê`;
        }

        function switchTab(t) {
            ['view-today', 'view-detail-stats', 'view-milestones', 'view-settings', 'view-about'].forEach(id => document.getElementById(id)?.classList.add('hidden'));
            document.getElementById('view-' + t)?.classList.remove('hidden');
            if (t === 'detail-stats') renderDetailedStats();
            if (t === 'milestones') renderMilestones();
            if (t === 'settings') document.getElementById('setting-name').value = USER_NAME;
            document.getElementById('bottom-bar').classList.toggle('hidden', t !== 'today');
            toggleSidebar();
            window.scrollTo(0,0);
        }

        function changeVibe(n, h) { CURRENT_VIBE = n; CURRENT_VIBE_HEX = h; localStorage.setItem('currentVibe', n); localStorage.setItem('currentVibeHex', h); applyVibe(); }
        function applyVibe() { document.documentElement.style.setProperty('--vibe-color', CURRENT_VIBE_HEX); document.getElementById('meta-theme-color').content = CURRENT_VIBE_HEX; }
        function updateUserNameSetting() { USER_NAME = document.getElementById('setting-name').value || "Disha"; localStorage.setItem('userName', USER_NAME); updateStaticText(); setHeader(); }
        function updateStaticText() { document.getElementById('sidebar-name').innerText = USER_NAME; document.getElementById('sidebar-avatar').innerText = USER_AVATAR; }
        function logoutProfile() { localStorage.removeItem('routine-profile'); location.reload(); }
        function toggleSidebar() { document.getElementById('sidebar').classList.toggle('closed'); document.getElementById('sidebar-overlay').classList.toggle('hidden'); }
        function toggleTheme() { const d = document.documentElement.classList.toggle('dark'); localStorage.setItem('theme', d ? 'dark' : 'light'); }
        function initTheme() { if (localStorage.getItem('theme') === 'dark') document.documentElement.classList.add('dark'); }
        function showPositiveToast(m) {
            const t = document.createElement('div');
            t.className = "floating-message bg-white dark:bg-slate-800 vibe-text px-6 py-3 rounded-full shadow-xl font-bold mb-4 text-xs";
            t.innerText = m || "Great job! ‚ú®";
            document.getElementById('toast-container').appendChild(t);
            setTimeout(() => t.remove(), 2000);
        }
        function playSparkleSound() { /* Built-in Web Audio oscillator */ }
        function setupPWA() { /* Manifest & SW Logic */ }
        function triggerConfetti() { /* Confetti Logic */ }

        window.onload = initGate;
    </script>
</body>
</html>
